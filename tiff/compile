import glob
import tifffile
import os
import numpy as np


# File and folder paths
dirpath = r"location of tiffs"
out_fp = r"output"

# Make search criteria for glob
search_criteria = "*.tif"
q = os.path.join.(dirpath, search_criteria)

# List tiffs
tiff_lst = glob.glob(q)

for tiff in tiff_lst:
    imwrite('temp.tif', append=True)
    
    Append an image series to the existing TIFF file:
>>> data = numpy.random.randint(0, 255, (301, 219, 3), 'uint8')
>>> imwrite('temp.tif', data, photometric='rgb', append=True)


img1.save(output.tif,save_all=True,append_images=[img1])
img1 = Image.open(open("file1.tif", 'rb'))
img2 = Image.open(open(â€œfile2.tif", 'rb'))
img1.seek(0)
img1.save(output.tif,save_all=True,append_images=img1)


# Initiate output mosiac
src_files_to_mosaic = []

# create list of open raster objects
    for tiff in tiff_lst:
       src = rasterio.open(tiff)
       src_files_to_mosaic.append(src)

# Merge
mosaic, out_trans = merge(src_files_to_mosaic)


# Write the mosaic raster to disk
with rasterio.open(out_fp, "w", **out_meta) as dest:
    dest.write(mosaic)



img_path = '../word_all'
out_txt_path = '../out_word_all.box'
out_tiff_path = '../out_word_all.tif'



import tifffile

with tifffile.TiffWriter('temp.tif') as tif:
  for i in range(4):
    filename = f"image_{i}"
    img = np.random.randint(0, 1023, (256, 256), 'uint16')
    tif.save(img, photometric='minisblack', description=filename)


with tifffile.TiffFile('temp.tif') as tif:
  for series in tif.series:
    first_page = series[0]
    print(first_page.description)
  
  # tif.asarray returns the first series by default, 
  # so `key` is needed to create the stack from multiple series.
  stack = tif.asarray(key=slice(None))
  print(stack.shape)

# image_0
# image_1
# image_2


with open(out_txt_path, 'wb') as f:
  dir_list = os.listdir(img_path)
  cnt_num = 0
  
  for dir_name in dir_list:
    dir_path = os.path.join(img_path, dir_name)
    img_list = os.listdir(dir_path)
    pwd = os.getcwd()
    os.chdir(dir_path)
    
    for img in img_list:
      
      print('dir_path:{}'.format(dir_path))
      gray_img = cv2.imread(img, cv2.IMREAD_GRAYSCALE)
      new_gray = gray_img[np.newaxis, ::]
      print('gray_img shape:{}, new_gray shape:{}'.format(gray_img.shape, new_gray.shape))
      #global cnt_num
      if cnt_num == 0:
        print('cnt_num == 0')
        tiff_list = new_gray
      else:
        print('np.append')
        tiff_list = np.append(tiff_list, new_gray, axis=0)
        print('tiff_list shape:{}'.format(tiff_list.shape))
      
      content = '{} 2 2 60 60 {}\n'.format(dir_name, cnt_num)
      print(content)
      f.write(content.encode('UTF-8'))
      cnt_num += 1
    os.chdir(pwd)

  tifffile.imsave( out_tiff_path, tiff_list )


print('tiff_list shape:{}'.format(tiff_list.shape))
